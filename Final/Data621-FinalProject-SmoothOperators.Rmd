---
title: "DATA621-FinalProject-SmoothOperators"
author: "Rob Hodde, Matt Farris, Jeffrey Burmood, Bin Lin"
date: "5/11/2017"
output: pdf_document
---

##Problem Description  
  
Our final project will explore, analyze and model a data set containing information on approximately 5,000 movies. The dataset contains movie data extracted from the IMDB website and is available on Kaggle.com.

The project will develop predictive models for two questions:  
  
1) Will the movie make money, lose money, or break even (approximately)?  
  
2) What is the anticipated gross margin (profit) for the movie?  


\begin{center}
{\huge Data Exploration}
\end{center}
  
##Data Exploration
  
```{r,echo=FALSE}
# Load required libraries

suppressWarnings(suppressMessages(library(ggplot2)))
suppressWarnings(suppressMessages(library(ROCR)))
suppressWarnings(suppressMessages(library(RCurl)))
suppressWarnings(suppressMessages(library(knitr)))
suppressWarnings(suppressMessages(library(Hmisc)))
suppressWarnings(suppressMessages(library(caret)))
suppressWarnings(suppressMessages(library(stringr)))
suppressWarnings(suppressMessages(library(mice)))
suppressWarnings(suppressMessages(library(dplyr)))
suppressWarnings(suppressMessages(library(reshape2)))
suppressWarnings(suppressMessages(library(MASS)))
suppressWarnings(suppressMessages(library(pscl)))
suppressWarnings(suppressMessages(library(broom)))
suppressWarnings(suppressMessages(library(lmtest)))

# Read in the dataset from github
movies.raw <- read.csv(text=getURL("https://raw.githubusercontent.com/jeffreyburmood/data621/master/Final/movie_metadata.csv"),header=TRUE,na.strings=c(""," "), stringsAsFactors = FALSE)

cpi <- read.csv(text=getURL("https://raw.githubusercontent.com/jeffreyburmood/data621/master/Final/CPI-Year.csv"),header=TRUE,na.strings=c(""," "), stringsAsFactors = FALSE)
names(cpi)<-c("title_year","cpi")

# Remove the columns not being used in the analysis
col.remove <- c(1,2,3,7,10,11,15,17,18,19,20,21,27,28)
movies <- subset(movies.raw,select=-col.remove)

# there are only a few NAs, go ahead and remove rows with NAs
movies <- na.omit(movies)

movies$movie_title <- iconv(movies$movie_title, "latin1", "ASCII", sub="")
```
  
```{r,echo=FALSE,fig.width = 8, fig.height = 3}
# Let's start by exploring the type of each variable
types <- sapply(1:length(movies),function(x) typeof(movies[,x]))
types.df <- data.frame(VAR=names(movies),TYPE=types)
kable(types.df)

# Set up content rating as factors to form a categorical variable for modeling
movies$content_rating <- factor(movies$content_rating)

# Show a statistical summary of the data
summary(movies)

# grab just the numeric data columns for variable analysis
movies.numeric <- subset(movies,select=-c(6,10,24))

# start by looking for correlations between the numeric variables (ONLY the predictor variables)
movies.pred <- subset(movies.numeric, select=-c(5))
cor.table <- cor(movies.pred) # build a table of inter-variable correlation values
kable(cor.table[,1:4])
kable(cor.table[,5:8])
kable(cor.table[,9:10])

# Look at the boxplots of the numeric variables
f <- colnames(movies.numeric)  # establish the data categories to be studied
par(mfrow=c(1,2))

for (i in 1:length(f)){
  boxplot(movies.numeric[,i],main = f[i])
}

# we also need to look at the histograms for the numeric variables
for (i in 1:length(f)){
  m <- mean(movies.numeric[,i])
  s <- sd(movies.numeric[,i])  
  hist(movies.numeric[,i],freq=FALSE,main = f[i],xlab="")
  curve(dnorm(x,mean=m,sd=s),col="darkblue",lwd=2,add=TRUE)
}

# let's also look at a quick plot of the data for each variable
for (i in 1:length(f)){
  plot(movies.numeric[,i],main = f[i],xlab="",ylab="")
}

```
  
After exploring the data, we noticed there is a scattering of NAs across the variables. Due to the relatively low number of total NAs, we choose to remove all rows with NAs, leaving 3,828 rows of data.  

Next, the content_rating variable is converted to a factor so the rating categories can be used with the regression models.  
  


\begin{center}
{\huge Data Preparation}
\end{center}


##Data Preparation  

One of the big issues faced in when using this dataset is the time frame. These movies were collected over the past 80+ years, and the following shows are distribution over time: 

```{r,echo=FALSE}
hist(movies$title_year,main = "Year Released",xlab="")
```
  

As you can see, the vast majority came from 1990s and above, but we can't discredit the movies from previous year. In order to accurately portray elements from the past, we have instituted a rate of inflation calculation. Using the consumer price index (for our part here we are making a crucial assumption, that all dollars are calculated based on US currency, and we are ignoring even more complex foreign exchange rates of the time), we can calculate the gross value per year. As a basis of comparison, we are using the CPI index from 2016, as the last movie was made in 2016. 


```{r}
movies <- merge(x = movies, y = cpi, by = "title_year")
movies$adj_gross <- with(movies, (240/cpi * gross))
movies$adj_budget <- with(movies, (240/cpi * budget))
movies$adj_margin <- with(movies, adj_gross-adj_budget)
```

```{r}
attach(movies)
plot(title_year,gross)
plot(title_year,adj_gross)
```

From the above graphs, we can see that the adjustment for the gross did indeed create a more uniformed dataset (where as before we saw movies increasing over the years). As a point of interest, the movies that made over a billion dollars are shown below:
```{r}
highest_gross <- subset(movies, adj_gross > 1000000000, 
                        select=c("movie_title", "gross","adj_gross") )
highest_gross
```

```{r}
boxplot(movies$adj_margin)
```


\begin{center}
{\huge Build Models}
\end{center}
##Build Models  
  
```{r,echo=FALSE}
# Now we're ready to explore model building. In preparation, split the dataset into a training set
# and a test set
## 80% of the sample size
set.seed(121)
smp_size <- floor(0.80 * nrow(movies))
## set the seed to make your partition reproductible
train_ind <- sample(seq_len(nrow(movies)), size = smp_size)
train <- movies[train_ind, ]
test <- movies[-train_ind, ]
```  
###Profit Margin Model
```{r}
#Elminate title_year, gross, budget, cpi
movies_new <- Filter(is.numeric, movies)
profit_margin <- movies_new$adj_margin / movies_new$adj_gross
movies_new <- cbind(movies_new, profit_margin)
movies_new <- subset(movies_new,select = -c(1, 6, 10, 12, 13))
##Also exclude adj_margin profit_margin when building models for gross prediction, because they are simply the linear combinations of the other two variables, adj_gross and adj_budget. 
m1 <- lm(adj_gross ~. - adj_margin - profit_margin, data = movies_new) 
summary(m1)
m1_back <- step(m1, trace = 0)
summary(m1_back)
gross_p <- predict(m1_back, newdata = movies_new, type = "response")
plot(m1_back)
plot(x = gross_p, y = movies_new$adj_gross, xlab = "Predicted Gross", ylab = "Actual Adjusted Gross") 
abline(a=0,b=1)
profit_margin_p <- (gross_p - movies_new$adj_budget) / gross_p
movies_p <- data.frame(movies$movie_title, movies_new$adj_budget, movies_new$adj_gross, gross_p, movies_new$profit_margin, profit_margin_p)
colnames(movies_p) <- c("Movie Title", "Actual Adjusted Budget", "Actualy Adjusted Gross", "Predicted Gross", "Actualy Profit Margin", "Predicted Profit Margin")
head(movies_p)
```